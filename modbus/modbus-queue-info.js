"use strict";module.exports=function(i){require("source-map-support").install();var u=require("./modbus-basics"),o=require("./core/modbus-queue-core"),s=require("debug")("contribModbus:queue");i.nodes.registerType("modbus-queue-info",function(e){i.nodes.createNode(this,e),this.name=e.name,this.topic=e.topic,this.unitid=parseInt(e.unitid)||1,this.lowLowLevel=parseInt(e.lowLowLevel),this.lowLevel=parseInt(e.lowLevel),this.highLevel=parseInt(e.highLevel),this.highHighLevel=parseInt(e.highHighLevel),this.errorOnHighLevel=e.errorOnHighLevel,this.queueReadIntervalTime=e.queueReadIntervalTime||1e3,this.showStatusActivities=e.showStatusActivities,this.updateOnAllQueueChanges=e.updateOnAllQueueChanges,this.updateOnAllUnitQueues=e.updateOnAllUnitQueues,this.internalDebugLog=s;var n=this;n.queueReadInterval=null,n.updateStatusRrunning=!1,n.unitsWithQueue=new Map,u.setNodeStatusTo("waiting",n);var a=i.nodes.getNode(e.server);a&&(a.registerForModbus(n),n.initUnitQueueStates=function(){for(var e=0;e<256;e+=1)n.unitsWithQueue.set(e,{}),n.resetStates(e)},n.resetStates=function(e){e=n.unitsWithQueue.get(e);e.lowLowLevelReached=!0,e.lowLevelReached=!1,e.highLevelReached=!1,e.highHighLevelReached=!1},n.errorProtocolMsg=function(e,t){u.logMsgError(n,e,t),u.sendEmptyMsgOnFail(n,e,t)},n.initUnitQueueStates(),n.checkLowLevelReached=function(e,t,u){var i=e.unitsWithQueue.get(u);!i.lowLevelReached&&t>e.lowLowLevel&&t<e.lowLevel&&(i.lowLevelReached=!0,t={payload:Date.now(),topic:e.topic,state:"low level reached",unitid:u,modbusClientName:a.name,bufferCommandListLength:t},e.send(t))},n.checkHighLevelReached=function(e,t,u){var i=e.unitsWithQueue.get(u);!i.highLevelReached&&t>e.lowLevel&&t>e.highLevel&&(i.highLevelReached=!0,t={payload:Date.now(),topic:e.topic,state:"high level reached",unitid:u,modbusClientName:a.name||a.id,highLevel:e.highLevel,bufferCommandListLength:t},e.errorOnHighLevel?e.error(new Error("Queue High Level Reached"),t):e.warn(t),e.send(t))},n.checkHighHighLevelReached=function(e,t,u){var i=e.unitsWithQueue.get(u);!i.highHighLevelReached&&t>e.highLevel&&t>e.highHighLevel&&(i.highHighLevelReached=!0,t={payload:Date.now(),topic:e.topic,state:"high high level reached",unitid:u,modbusClientName:a.name||a.id,highLevel:e.highLevel,highHighLevel:e.highHighLevel,bufferCommandListLength:t},e.error(new Error("Queue High High Level Reached"),t),e.send(t))},n.getStatusSituationFillColor=function(e){var t=n.unitsWithQueue.get(e),e="blue";return t.lowLevelReached&&(e="green"),t.highLevelReached&&(e=n.errorOnHighLevel?"red":"yellow"),e=t.highHighLevelReached?"red":e},n.setNodeStatusByActivity=function(e,t){n.showStatusActivities&&n.status({fill:n.getStatusSituationFillColor(n.unitid),shape:"ring",text:e?"active unit "+t+" queue items: "+e:"active (Unit-Id: "+t+") empty"})},n.readFromQueue=function(){if(!n.updateStatusRrunning){var i=n.unitid<1||255<n.unitid?1:n.unitid;if(a.bufferCommands)return new Promise(function(e,t){try{n.updateStatusRrunning=!0;var u=a.bufferCommandList.get(i).length;n.checkQueueStates(u,i),n.setNodeStatusByActivity(u,i),n.updateStatusRrunning=!1,e()}catch(e){n.updateStatusRrunning=!1,t(e)}});n.showStatusActivities&&n.setNodeStatusByActivity(null,i)}},n.checkQueueStates=function(e,t){!n.unitsWithQueue.get(t).lowLowLevelReached&&e<n.lowLowLevel&&n.resetStates(t),n.checkLowLevelReached(n,e,t),n.checkHighLevelReached(n,e,t),n.checkHighHighLevelReached(n,e,t)},n.readFromAllUnitQueues=function(){if(!n.updateStatusRrunning)return a.bufferCommands?new Promise(function(e,t){try{n.updateStatusRrunning=!0;for(var u,i=0;i<256;i+=1)(u=a.bufferCommandList.get(i).length)&&n.checkQueueStates(u,i);n.updateStatusRrunning=!1,e()}catch(e){n.updateStatusRrunning=!1,t(e)}}):void 0},n.registerModbusQueueActionsToNode=function(e){n.updateOnAllQueueChanges&&a.on("mbqueue",e),a.on("mbactive",e),a.on("mbinit",e),a.on("mbconnected",e),a.on("mberror",e),a.on("mbclosed",e),n.queueReadInterval=setInterval(e,n.queueReadIntervalTime)},n.removeModbusQueueActionsFromNode=function(e){a.removeListener("mbqueue",e),a.removeListener("mbactive",e),a.removeListener("mbinit",e),a.removeListener("mbconnected",e),a.removeListener("mberror",e),a.removeListener("mbclosed",e)},n.updateOnAllUnitQueues?(n.registerModbusQueueActionsToNode(n.readFromAllUnitQueues),u.setNodeStatusTo("active for all queues",n)):n.registerModbusQueueActionsToNode(n.readFromQueue),n.on("input",function(t){var u=n.unitid;if(t.payload={},t.payload.queueEnabled=a.bufferCommands,n.updateOnAllUnitQueues)t.payload.allQueueData=!0,t.payload.queues=a.bufferCommandList;else{try{u=t.payload.resetQueue?parseInt(t.payload.unitId)||n.unitid:parseInt(t.payload)||n.unitid}catch(e){n.errorProtocolMsg(e,t),u=n.unitid}t.payload.allQueueData=!1,t.payload.unitid=u,t.payload.queue=a.bufferCommandList.get(u)}t.payload.queueOptions={date:Date.now(),state:"queue request",modbusClientName:a.name||a.id,lowlowLevel:n.lowlowLevel,unitId:u,lowLevel:n.lowLevel,highLevel:n.highLevel,highHighLevel:n.highHighLevel},(t.payload.resetQueue||t.resetQueue)&&a.bufferCommands&&(o.initQueue(a),i.settings.verbose&&(a.warn(u="Init Queue By External Node"),s(u)),n.initUnitQueueStates(),n.showStatusActivities&&n.status({fill:"blue",shape:"ring",text:"active empty unit queue"}),t.payload.queueOptions.state="queue reset done"),n.send(t)}),n.on("close",function(e){n.updateOnAllUnitQueues?n.removeModbusQueueActionsFromNode(n.readFromAllUnitQueues):n.removeModbusQueueActionsFromNode(n.readFromQueue),u.setNodeStatusTo("closed",n),n.queueReadInterval&&clearInterval(n.queueReadInterval),n.queueReadInterval=null,a.deregisterForModbus(n.id,e)}),n.showStatusActivities||u.setNodeDefaultStatus(n))})};
//# sourceMappingURL=maps/modbus-queue-info.js.map
