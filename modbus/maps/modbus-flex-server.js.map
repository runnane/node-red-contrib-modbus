{"version":3,"sources":["modbus-flex-server.js"],"names":["module","exports","RED","require","install","coreServer","mbBasics","type","message","config","nodes","createNode","this","_require","VMScript","logEnabled","internalDebugLog","serverAddress","serverPort","parseInt","responseDelay","ModbusFlexServer","delayUnit","unitId","minAddress","VM","splitAddress","name","funcGetCoil","compile","funcGetDiscreteInput","funcGetInputRegister","funcGetHoldingRegister","funcSetCoil","funcSetRegister","showErrors","verbose","buildMessage","msg","disableMsgOutput","payload","node","registers","slice","bufferFactor","send","coils","verboseLogging","alloc","settings","Buffer","registersBufferSize","coilsBufferSize","vector","vm","sandbox","run","startServer","modbusServer","ModbusRTU","ServerTCP","host","port","debug","unitID","err","error","on","close","_server","sock","stringify","address","remoteAddress","remotePort","setNodeStatusTo","showStatusActivities","setNodeDefaultStatus","writeToFlexServerMemory"],"mappings":"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","file":"../modbus-flex-server.js","sourcesContent":["/**\r\n Copyright (c) 2017,2018,2019,2020,2021 Klaus Landsdorf (https://bianco-royal.space/)\r\n All rights reserved.\r\n node-red-contrib-modbus - The BSD 3-Clause License\r\n\r\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\r\n **/\r\n/**\r\n * Modbus Server node.\r\n * @module NodeRedModbusServer\r\n *\r\n * @param RED\r\n */\r\nmodule.exports = function (RED) {\r\n  'use strict'\r\n  require('source-map-support').install()\r\n  const ModbusRTU = require('modbus-serial')\r\n  const coreServer = require('./core/modbus-server-core')\r\n  const mbBasics = require('./modbus-basics')\r\n  const internalDebugLog = require('debug')('contribModbus:flex:server')\r\n\r\n  function ModbusFlexServer (config) {\r\n    RED.nodes.createNode(this, config)\r\n    const { VM, VMScript } = require('vm2')\r\n\r\n    this.name = config.name\r\n    this.logEnabled = config.logEnabled\r\n    this.serverAddress = config.serverAddress || '0.0.0.0'\r\n    this.serverPort = parseInt(config.serverPort)\r\n    this.responseDelay = parseInt(config.responseDelay)\r\n    this.delayUnit = config.delayUnit\r\n    this.unitId = parseInt(config.unitId) || 1\r\n    this.minAddress = parseInt(config.minAddress) || 0\r\n    this.splitAddress = parseInt(config.splitAddress) || 10000\r\n    this.showErrors = config.showErrors\r\n\r\n    this.funcGetCoil = new VMScript(config.funcGetCoil).compile()\r\n    this.funcGetDiscreteInput = new VMScript(config.funcGetDiscreteInput).compile()\r\n    this.funcGetInputRegister = new VMScript(config.funcGetInputRegister).compile()\r\n    this.funcGetHoldingRegister = new VMScript(config.funcGetHoldingRegister).compile()\r\n\r\n    this.funcSetCoil = new VMScript(config.funcSetCoil).compile()\r\n    this.funcSetRegister = new VMScript(config.funcSetRegister).compile()\r\n\r\n    this.internalDebugLog = internalDebugLog\r\n    this.verboseLogging = RED.settings.verbose\r\n\r\n    const node = this\r\n    node.bufferFactor = coreServer.bufferFactor\r\n\r\n    node.coilsBufferSize = parseInt(config.coilsBufferSize * coreServer.bufferFactor)\r\n    node.registersBufferSize = parseInt(config.registersBufferSize * coreServer.bufferFactor)\r\n\r\n    node.coils = Buffer.alloc(node.coilsBufferSize, 0)\r\n    node.registers = Buffer.alloc(node.registersBufferSize, 0)\r\n\r\n    node.modbusServer = null\r\n\r\n    mbBasics.setNodeStatusTo('initialized', node)\r\n\r\n    //     1...10000*  address - 1      Coils (outputs)    0   Read/Write\r\n    // 10001...20000*  address - 10001  Discrete Inputs    01  Read\r\n    // 30001...40000*  address - 30001  Input Registers    04  Read\r\n    // 40001...50000*  address - 40001  Holding Registers  03  Read/Write\r\n\r\n    node.vector = {}\r\n\r\n    const vm = new VM({\r\n      sandbox: { node }\r\n    })\r\n\r\n    vm.run('node.vector.getCoil = ' + config.funcGetCoil)\r\n    vm.run('node.vector.getDiscreteInput = ' + config.funcGetDiscreteInput)\r\n    vm.run('node.vector.getInputRegister = ' + config.funcGetInputRegister)\r\n    vm.run('node.vector.getHoldingRegister = ' + config.funcGetHoldingRegister)\r\n\r\n    vm.run('node.vector.setCoil = ' + config.funcSetCoil)\r\n    vm.run('node.vector.setRegister = ' + config.funcSetRegister)\r\n\r\n    node.startServer = function () {\r\n      try {\r\n        if (node.modbusServer === null) {\r\n          try {\r\n            node.modbusServer = new ModbusRTU.ServerTCP(node.vector, {\r\n              host: node.serverAddress,\r\n              port: node.serverPort,\r\n              debug: node.logEnabled,\r\n              unitID: node.unitId\r\n            })\r\n          } catch (err) {\r\n            node.error(err, { payload: 'server net error -> for port 502 on unix, you have to be a super user' })\r\n          }\r\n\r\n          node.modbusServer.on('socketError', function (err) {\r\n            internalDebugLog(err.message)\r\n            if (node.showErrors) {\r\n              node.warn(err)\r\n            }\r\n            mbBasics.setNodeStatusTo('error', node)\r\n\r\n            node.modbusServer.close(function () {\r\n              node.startServer()\r\n            })\r\n          })\r\n\r\n          node.modbusServer._server.on('connection', function (sock) {\r\n            internalDebugLog('Modbus Flex Server client connection')\r\n            if (sock) {\r\n              internalDebugLog('Modbus Flex Server client to ' + JSON.stringify(sock.address()) + ' from ' + sock.remoteAddress + ' ' + sock.remotePort)\r\n            }\r\n            mbBasics.setNodeStatusTo('active', node)\r\n          })\r\n        }\r\n\r\n        if (!node.showStatusActivities) {\r\n          mbBasics.setNodeDefaultStatus(node)\r\n        }\r\n      } catch (err) {\r\n        internalDebugLog(err.message)\r\n        if (node.showErrors) {\r\n          node.warn(err)\r\n        }\r\n        mbBasics.setNodeStatusTo('error', node)\r\n      }\r\n\r\n      if (node.modbusServer != null) {\r\n        internalDebugLog('Modbus Flex Server listening on modbus://' + node.serverAddress + ':' + node.serverPort)\r\n        mbBasics.setNodeStatusTo('initialized', node)\r\n      } else {\r\n        internalDebugLog('Modbus Flex Server isn\\'t ready')\r\n        mbBasics.setNodeStatusTo('error', node)\r\n      }\r\n    }\r\n\r\n    node.startServer()\r\n\r\n    node.on('input', function (msg) {\r\n      if (coreServer.isValidMemoryMessage(msg)) {\r\n        coreServer.writeToFlexServerMemory(node, msg)\r\n        if (msg.payload.disableMsgOutput !== 1) {\r\n          node.send(buildMessage(msg))\r\n        }\r\n      } else {\r\n        if (node.showErrors) {\r\n          node.error('Is Not A Valid Memory Write Message To Server', msg)\r\n        }\r\n        if (!msg.payload.disableMsgOutput) {\r\n          node.send(buildMessage(msg))\r\n        }\r\n      }\r\n    })\r\n\r\n    function buildMessage (msg) {\r\n      return [\r\n        { type: 'holding', message: msg, payload: node.registers.slice(node.splitAddress * coreServer.bufferFactor) },\r\n        { type: 'coils', message: msg, payload: node.coils.slice(0, node.splitAddress * coreServer.bufferFactor) },\r\n        { type: 'input', message: msg, payload: node.registers.slice(0, node.splitAddress * coreServer.bufferFactor) },\r\n        { type: 'discrete', message: msg, payload: node.coils.slice(node.splitAddress * coreServer.bufferFactor) },\r\n        { payload: 'request', type: 'message', message: msg }\r\n      ]\r\n    }\r\n\r\n    node.on('close', function () {\r\n      mbBasics.setNodeStatusTo('closed', node)\r\n      if (node.modbusServer._server) {\r\n        node.modbusServer._server.close()\r\n      }\r\n      if (node.modbusServer) {\r\n        node.modbusServer.close()\r\n      }\r\n      node.modbusServer = null\r\n    })\r\n  }\r\n\r\n  try {\r\n    RED.nodes.registerType('modbus-flex-server', ModbusFlexServer)\r\n  } catch (err) {\r\n    internalDebugLog(err.message)\r\n  }\r\n}\r\n"]}