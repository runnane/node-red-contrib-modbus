{"version":3,"sources":["modbus-flex-connector.js"],"names":["module","exports","RED","require","install","internalDebugLog","nodes","registerType","createNode","this","config","name","maxReconnectsPerMinute","emptyQueue","showStatusActivities","showErrors","settings","connection","mbBasics","node","getNode","server","modbusClient","initModbusClientEvents","onConfigDone","msg","onConfigError","err","message","error","nodeStatus","statusText","payload","send","on","emptyMsgOnFail","invalidPayloadIn","client","setNodeStatusTo","actualServiceState","connectorType","JSON","stringify","Error"],"mappings":"aAUAA,OAAAC,QAAA,SAAAC,GAEAC,QAAA,sBAAAC,UACAJ,IAAOC,EAAUE,QAAUD,mBACzBG,EAAAF,QAAA,QAAAA,CAAA,gCAsFAD,EAAII,MAAMC,aAAa,wBArFvBJ,SAA8BC,GAK5BF,EAAII,MAAME,WAAWC,KAAMC,GAE3BD,KAAKE,KAAOD,EAAOC,KALrBF,KAAMJ,uBAA2BK,EAARE,wBAAiB,EAOxCH,KAAKI,WAAaH,EAAOG,WAL3BJ,KAAAK,qBAA8BJ,EAAQI,qBACpCZ,KAAII,WAAME,EAAVO,WAEAN,KAAKE,WAAa,KAElBF,KAAKI,iBAAmBR,EACxBI,KAAKK,eAAAA,EAALE,SAAmCF,QAEnC,IAAKG,EAAAA,KAELC,EAAKb,gBAAmBA,UAAAA,GAGxB,IAAMc,EAANjB,EAAAI,MAAAc,QAAAV,EAAAW,QACAH,IAGAI,EAAKA,kBAAcH,GACjBD,EAAAK,uBAAAJ,EAAAG,GAKFH,EAAKK,aAAe,SAAUC,GAH9BH,EAAAA,sBACAJ,EAASK,gBAAAA,cAA6BD,GAEtCH,EAAKK,cAAe,UAClBL,EAAIA,KAAKL,IAOXK,EAAKO,cAAgB,SAAUC,EAAKF,GAJlCA,EAAAE,EAAoBC,SAChBT,EAAJJ,YALFI,EAAAU,MAAAF,EAAAF,GASEpB,GAAAA,EAAAA,QAMEoB,EAAII,MAAQF,EAJZR,EAAIU,MAAOF,IAAKF,MAAhBE,GAQFF,EAAII,MAAMC,WAAaX,EAAKY,WAJ1BN,EAAII,iBADNJ,EAAAO,QAEO,IASPb,EAAKc,KAAKR,IAJVN,EAAAe,GAAIf,QAAKgB,SAAgBV,GACvBA,IAiBDI,EAjBCJ,EAAAW,iBAAAX,IAdJH,EAAAe,SAsBIlB,EAAAL,sBACDI,EAAAoB,gBAAAhB,EAAAiB,mBAAApB,GAGCM,EAAAO,QAAAQ,eACDnC,EAAA,qBAAAoC,KAAAC,UAAAjB,EAAAO,UAQCP,EAAIO,QAAQnB,WAAaM,EAAKN,WANhCS,EAASR,KAAAA,mBAAsBW,EAAAN,EAAAK,aAAAL,EAAAO,iBAE9BG,EAAA,IAAAc,MAAA,sCAQCxB,EAAKU,MAAMA,EAAOJ,GALlBpB,EAAAA,KAAAA,OAIAc,EAAMU,sBACNV,EAAKU,qBAALV","file":"../modbus-flex-connector.js","sourcesContent":["/**\r\n Copyright (c) 2017,2018,2019,2020,2021 Klaus Landsdorf (https://bianco-royal.space/)\r\n All rights reserved.\r\n node-red-contrib-modbus - The BSD 3-Clause License\r\n\r\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\r\n */\r\n/**\r\n * Modbus flexible Getter node.\r\n * @module NodeRedModbusFlexGetter\r\n *\r\n * @param RED\r\n */\r\nmodule.exports = function (RED) {\r\n  'use strict'\r\n  require('source-map-support').install()\r\n  const mbBasics = require('./modbus-basics')\r\n  const internalDebugLog = require('debug')('contribModbus:flex:connector')\r\n\r\n  function ModbusFlexConnector (config) {\r\n    RED.nodes.createNode(this, config)\r\n\r\n    this.name = config.name\r\n    this.maxReconnectsPerMinute = config.maxReconnectsPerMinute || 4\r\n    this.emptyQueue = config.emptyQueue\r\n    this.showStatusActivities = config.showStatusActivities\r\n    this.showErrors = config.showErrors\r\n    this.connection = null\r\n\r\n    this.internalDebugLog = internalDebugLog\r\n    this.verboseLogging = RED.settings.verbose\r\n\r\n    const node = this\r\n    mbBasics.setNodeStatusTo('waiting', node)\r\n\r\n    const modbusClient = RED.nodes.getNode(config.server)\r\n    if (!modbusClient) {\r\n      return\r\n    }\r\n    modbusClient.registerForModbus(node)\r\n    mbBasics.initModbusClientEvents(node, modbusClient)\r\n\r\n    node.onConfigDone = function (msg) {\r\n      if (node.showStatusActivities) {\r\n        mbBasics.setNodeStatusTo('config done', node)\r\n      }\r\n      msg.config_change = 'emitted'\r\n      node.send(msg)\r\n    }\r\n\r\n    node.onConfigError = function (err, msg) {\r\n      internalDebugLog(err.message)\r\n      if (node.showErrors) {\r\n        node.error(err, msg)\r\n      }\r\n\r\n      if (err && err.message) {\r\n        msg.error = err\r\n      } else {\r\n        msg.error = new Error(err)\r\n      }\r\n      msg.error.nodeStatus = node.statusText\r\n\r\n      if (node.emptyMsgOnFail) {\r\n        msg.payload = ''\r\n      }\r\n\r\n      node.send(msg)\r\n    }\r\n\r\n    node.on('input', function (msg) {\r\n      if (mbBasics.invalidPayloadIn(msg)) {\r\n        return\r\n      }\r\n\r\n      if (!modbusClient.client) {\r\n        return\r\n      }\r\n\r\n      if (node.showStatusActivities) {\r\n        mbBasics.setNodeStatusTo(modbusClient.actualServiceState, node)\r\n      }\r\n\r\n      if (msg.payload.connectorType) {\r\n        internalDebugLog('dynamicReconnect: ' + JSON.stringify(msg.payload))\r\n        msg.payload.emptyQueue = node.emptyQueue\r\n        modbusClient.emit('dynamicReconnect', msg, node.onConfigDone, node.onConfigError)\r\n      } else {\r\n        const error = new Error('Payload Not Valid - Connector Type')\r\n        node.error(error, msg)\r\n\r\n        node.send(msg)\r\n      }\r\n    })\r\n\r\n    if (!node.showStatusActivities) {\r\n      mbBasics.setNodeDefaultStatus(node)\r\n    }\r\n  }\r\n\r\n  RED.nodes.registerType('modbus-flex-connector', ModbusFlexConnector)\r\n}\r\n"]}