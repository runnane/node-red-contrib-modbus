{"version":3,"sources":["modbus-basics.js"],"names":["require","install","de","biancoroyal","modbus","basics","internalDebug","util","statusLog","get_timeUnit_name","unit","unitAbbreviation","calc_rateByUnit","rate","rateUnit","parseInt","setNodeStatusProperties","statusValue","showActivities","fillValue","shapeValue","statusText","value","shape","status","setNodeStatusByResponseTo","response","node","fill","text","this","inspect","setNodeStatusResponse","length","setModbusError","modbusClient","err","msg","setNodeStatusTo","emit","message","showStatusActivities","statusOptions","setNodeDefaultStatus","onModbusConnect","onModbusActive","onModbusError","failureMsg","showErrors","warn","onModbusClose","onModbusQueue","reconnectTimeout","on","_this","onModbusInit","onModbusBroken","invalidPayloadIn","Object","prototype","hasOwnProperty","call","invalidSequencesIn","sendEmptyMsgOnFail","payload","name","error","nodeStatus","logMsgError","buildNewMessage","keepMsgProperties","minMsg","assign","module"],"mappings":"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","file":"../modbus-basics.js","sourcesContent":["/**\r\n Copyright (c) 2016,2017,2018,2019,2020,2021 Klaus Landsdorf (https://bianco-royal.space/)\r\n All rights reserved.\r\n node-red-contrib-modbus - The BSD 3-Clause License\r\n\r\n @author <a href=\"mailto:klaus.landsdorf@bianco-royal.de\">Klaus Landsdorf</a> (Bianco Royal)\r\n **/\r\n'use strict'\r\nrequire('source-map-support').install()\r\n\r\n// eslint-disable-next-line no-var\r\nvar de = de || { biancoroyal: { modbus: { basics: {} } } } // eslint-disable-line no-use-before-define\r\nde.biancoroyal.modbus.basics.internalDebug = de.biancoroyal.modbus.basics.internalDebug || require('debug')('contribModbus:basics') // eslint-disable-line no-use-before-define\r\nde.biancoroyal.modbus.basics.util = de.biancoroyal.modbus.basics.util || require('util') // eslint-disable-line no-use-before-define\r\n\r\n/**\r\n * Modbus core node basics.\r\n * @module NodeRedModbusBasics\r\n */\r\nde.biancoroyal.modbus.basics.statusLog = false\r\n/**\r\n *\r\n * @param unit\r\n * @returns {string}\r\n */\r\nde.biancoroyal.modbus.basics.get_timeUnit_name = function (unit) {\r\n  let unitAbbreviation = ''\r\n\r\n  switch (unit) {\r\n    case 'ms':\r\n      unitAbbreviation = 'msec.'\r\n      break\r\n    case 's':\r\n      unitAbbreviation = 'sec.'\r\n      break\r\n    case 'm':\r\n      unitAbbreviation = 'min.'\r\n      break\r\n    case 'h':\r\n      unitAbbreviation = 'h.'\r\n      break\r\n    default:\r\n      break\r\n  }\r\n\r\n  return unitAbbreviation\r\n}\r\n\r\nde.biancoroyal.modbus.basics.calc_rateByUnit = function (rate, rateUnit) {\r\n  switch (rateUnit) {\r\n    case 'ms':\r\n      break\r\n    case 's':\r\n      rate = parseInt(rate) * 1000 // seconds\r\n      break\r\n    case 'm':\r\n      rate = parseInt(rate) * 60000 // minutes\r\n      break\r\n    case 'h':\r\n      rate = parseInt(rate) * 3600000 // hours\r\n      break\r\n    default:\r\n      rate = 10000 // 10 sec.\r\n      break\r\n  }\r\n\r\n  return rate\r\n}\r\n/**\r\n *\r\n * @param statusValue\r\n * @param showActivities\r\n * @returns {{fill: string, shape: string, status: *}}\r\n */\r\nde.biancoroyal.modbus.basics.setNodeStatusProperties = function (statusValue, showActivities) {\r\n  let fillValue = 'yellow'\r\n  let shapeValue = 'ring'\r\n\r\n  if (!statusValue) {\r\n    statusValue = 'waiting'\r\n  }\r\n\r\n  let statusText = statusValue.value || statusValue\r\n\r\n  switch (statusText) {\r\n    case 'connecting':\r\n      fillValue = 'yellow'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'error':\r\n      fillValue = 'red'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'initialized':\r\n    case 'init':\r\n      fillValue = 'yellow'\r\n      shapeValue = 'dot'\r\n      break\r\n\r\n    case 'not ready to read':\r\n    case 'not ready to write':\r\n      fillValue = 'yellow'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'connected':\r\n    case 'queueing':\r\n    case 'queue':\r\n      fillValue = 'green'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'timeout':\r\n      fillValue = 'red'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'active':\r\n    case 'reading':\r\n    case 'writing':\r\n    case 'active reading':\r\n    case 'active writing':\r\n      if (!showActivities) {\r\n        statusText = 'active'\r\n      }\r\n      fillValue = 'green'\r\n      shapeValue = 'dot'\r\n      break\r\n\r\n    case 'disconnected':\r\n    case 'terminated':\r\n      fillValue = 'red'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'stopped':\r\n      fillValue = 'red'\r\n      shapeValue = 'dot'\r\n      break\r\n\r\n    case 'polling':\r\n      fillValue = 'green'\r\n      if (showActivities) {\r\n        shapeValue = 'ring'\r\n      } else {\r\n        statusText = 'active'\r\n        shapeValue = 'dot'\r\n      }\r\n      break\r\n\r\n    default:\r\n      if (statusText === 'waiting') {\r\n        fillValue = 'blue'\r\n        statusText = 'waiting ...'\r\n      }\r\n      break\r\n  }\r\n\r\n  return { fill: fillValue, shape: shapeValue, status: statusText }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.setNodeStatusByResponseTo = function (statusValue, response, node) {\r\n  let fillValue = 'red'\r\n  let shapeValue = 'dot'\r\n\r\n  switch (statusValue) {\r\n    case 'initialized':\r\n    case 'queue':\r\n      fillValue = 'green'\r\n      shapeValue = 'ring'\r\n      break\r\n\r\n    case 'active':\r\n      fillValue = 'green'\r\n      shapeValue = 'dot'\r\n      break\r\n\r\n    default:\r\n      if (!statusValue || statusValue === 'waiting') {\r\n        fillValue = 'blue'\r\n        statusValue = 'waiting ...'\r\n      }\r\n      break\r\n  }\r\n\r\n  node.status({ fill: fillValue, shape: shapeValue, text: this.util.inspect(response, false, null) })\r\n}\r\n\r\nde.biancoroyal.modbus.basics.setNodeStatusResponse = function (length, node) {\r\n  node.status({\r\n    fill: 'green',\r\n    shape: 'dot',\r\n    text: 'active got length: ' + length\r\n  })\r\n}\r\n\r\nde.biancoroyal.modbus.basics.setModbusError = function (node, modbusClient, err, msg) {\r\n  if (err) {\r\n    switch (err.message) {\r\n      case 'Timed out':\r\n        this.setNodeStatusTo('timeout', node)\r\n        break\r\n      case 'FSM Not Ready To Reconnect':\r\n        this.setNodeStatusTo('not ready to reconnect', node)\r\n        break\r\n      case 'Port Not Open':\r\n        this.setNodeStatusTo('reconnect', node)\r\n        modbusClient.emit('reconnect')\r\n        break\r\n      default:\r\n        this.internalDebug(err.message)\r\n        if (node.showErrors) {\r\n          this.setNodeStatusTo('error ' + err.message, node)\r\n        }\r\n    }\r\n  }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.setNodeStatusTo = function (statusValue, node) {\r\n  if (node.showStatusActivities) {\r\n    if (statusValue !== node.statusText) {\r\n      const statusOptions = this.setNodeStatusProperties(statusValue, node.showStatusActivities)\r\n      node.statusText = statusValue\r\n      node.status({\r\n        fill: statusOptions.fill,\r\n        shape: statusOptions.shape,\r\n        text: statusOptions.status\r\n      })\r\n    } else {\r\n      this.setNodeDefaultStatus(node)\r\n    }\r\n  }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusInit = function (node) {\r\n  this.setNodeStatusTo('initialize', node)\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusConnect = function (node) {\r\n  this.setNodeStatusTo('connected', node)\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusActive = function (node) {\r\n  this.setNodeStatusTo('active', node)\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusError = function (node, failureMsg) {\r\n  this.setNodeStatusTo('failure', node)\r\n  if (node.showErrors) {\r\n    node.warn(failureMsg)\r\n  }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusClose = function (node) {\r\n  this.setNodeStatusTo('closed', node)\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusQueue = function (node) {\r\n  this.setNodeStatusTo('queueing', node)\r\n}\r\n\r\nde.biancoroyal.modbus.basics.onModbusBroken = function (node, modbusClient) {\r\n  this.setNodeStatusTo('reconnecting after ' + modbusClient.reconnectTimeout + ' msec.', node)\r\n}\r\n\r\nde.biancoroyal.modbus.basics.setNodeDefaultStatus = function (node) {\r\n  node.status({ fill: 'green', shape: 'ring', text: 'active' })\r\n}\r\n\r\nde.biancoroyal.modbus.basics.initModbusClientEvents = function (node, modbusClient) {\r\n  if (node.showStatusActivities) {\r\n    modbusClient.on('mbinit', () => { this.onModbusInit(node) })\r\n    modbusClient.on('mbqueue', () => { this.onModbusQueue(node) })\r\n    modbusClient.on('mbconnected', () => { this.onModbusConnect(node) })\r\n    modbusClient.on('mbbroken', () => { this.onModbusBroken(node, modbusClient) })\r\n    modbusClient.on('mbactive', () => { this.onModbusActive(node) })\r\n    modbusClient.on('mberror', (failureMsg) => { this.onModbusError(node, failureMsg) })\r\n    modbusClient.on('mbclosed', () => { this.onModbusClose(node) })\r\n  } else {\r\n    this.setNodeDefaultStatus(node)\r\n  }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.invalidPayloadIn = function (msg) {\r\n  return !(msg && Object.prototype.hasOwnProperty.call(msg, 'payload'))\r\n}\r\n\r\nde.biancoroyal.modbus.basics.invalidSequencesIn = function (msg) {\r\n  return !(msg && Object.prototype.hasOwnProperty.call(msg, 'sequences'))\r\n}\r\n\r\nde.biancoroyal.modbus.basics.sendEmptyMsgOnFail = function (node, err, msg) {\r\n  if (node.emptyMsgOnFail) {\r\n    msg.payload = ''\r\n\r\n    if (err && err.message && err.name) {\r\n      msg.error = err\r\n    } else {\r\n      msg.error = Error(err)\r\n    }\r\n    msg.error.nodeStatus = node.statusText\r\n\r\n    node.send([msg, msg])\r\n  }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.logMsgError = function (node, err, msg) {\r\n  if (node.showErrors) {\r\n    node.error(err, msg)\r\n  }\r\n}\r\n\r\nde.biancoroyal.modbus.basics.buildNewMessage = function (keepMsgProperties, msg, minMsg) {\r\n  if (keepMsgProperties) {\r\n    return Object.assign(msg, minMsg)\r\n  } else {\r\n    return minMsg\r\n  }\r\n}\r\n\r\nmodule.exports = de.biancoroyal.modbus.basics\r\n"]}